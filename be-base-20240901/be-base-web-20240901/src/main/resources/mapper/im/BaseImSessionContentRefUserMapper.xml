<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kar20240901.be.base.web.mapper.im.BaseImSessionContentRefUserMapper">
  <select id="queryLastContent"
    resultType="com.kar20240901.be.base.web.model.vo.im.BaseImSessionRefUserQueryLastContentVO">
    SELECT a.session_id                AS sessionId,
           SUBSTRING(b.content, 1, 16) AS lastContent,
           b.create_time               AS lastContentCreateTime,
           b.type                      AS lastContentType

    FROM (SELECT subA.session_id, MAX(subA.content_id) AS maxContentId
          FROM base_im_session_content_ref_user subA

    WHERE subA.user_id = #{currentUserId}

      AND subA.show_flag = TRUE

    <if test="sessionIdList != null and sessionIdList.size != 0">
      AND subA.session_id IN
      <foreach collection="sessionIdList" separator="," open="(" close=")" item="item">
        #{item}
      </foreach>
    </if>

    GROUP BY subA.session_id) a

      LEFT JOIN base_im_session_content b
                ON b.id = a.maxContentId
                  AND b.enable_flag = TRUE;
  </select>

  <select id="myPage"
    resultType="com.kar20240901.be.base.web.model.vo.im.BaseImSessionContentRefUserPageVO">
    SELECT b.id         AS contentId,
           b.create_ts  AS createTs,
           b.type       AS type,
           b.content    AS content,
           b.create_id  AS createId,
           b.ref_id     AS refId,
           b.session_id AS sessionId,
           b.order_no   AS orderNo

    FROM base_im_session_content_ref_user a
           LEFT JOIN base_im_session_content b ON b.id = a.content_id

    WHERE a.user_id = #{currentUserId}

      AND a.show_flag = TRUE

      AND b.enable_flag = TRUE

      AND a.session_id = #{dto.sessionId}

    <if test="dto.content != null and dto.content != ''">
      AND b.content LIKE CONCAT('%', #{dto.content}, '%')
    </if>

    <if test="dto.contentId != null">
      <choose>
        <when test="dto.backwardFlag == null">
          AND a.content_id = #{dto.contentId}
        </when>

        <when test="dto.backwardFlag">
          AND a.content_id <![CDATA[>]]> #{dto.contentId}
        </when>

        <otherwise>
          AND a.content_id <![CDATA[<]]> #{dto.contentId}
        </otherwise>
      </choose>
    </if>

    <choose>
      <when test="dto.backwardFlag == null">
        ORDER BY b.create_ts DESC, b.order_no DESC, b.id DESC
      </when>

      <when test="dto.backwardFlag">
        ORDER BY b.create_ts, b.order_no, b.id
      </when>

      <otherwise>
        ORDER BY b.create_ts DESC, b.order_no DESC, b.id DESC
      </otherwise>
    </choose>
  </select>

  <select id="searchPage"
    resultType="com.kar20240901.be.base.web.model.vo.im.BaseImSearchBaseContentVO">
    SELECT IF(MAX(c.name) = '', MAX(c.target_name), MAX(c.name)) AS showName,
           MAX(c.target_id)                                      AS targetId,
           MAX(c.target_type)                                    AS target_type,
           c.session_id                                          AS sessionId,
           MAX(c.avatar_url)                                     AS avatarUrl,
           COUNT(*)                                              AS searchCount

    FROM base_im_session_content_ref_user a

           LEFT JOIN base_im_session_content b ON b.id = a.content_id

           LEFT JOIN base_im_session_ref_user c
                     ON c.user_id = a.user_id AND c.session_id = a.session_id

    WHERE a.user_id = #{currentUserId}

      AND a.show_flag = TRUE

      AND b.enable_flag = TRUE

      AND c.session_id IS NOT NULL

    <if test="dto.content != null and dto.content != ''">
      AND b.content LIKE CONCAT('%', #{dto.content}, '%')
    </if>

    GROUP BY c.session_id

    ORDER BY MAX(b.create_ts) DESC, MAX(b.order_no) DESC
  </select>
</mapper>